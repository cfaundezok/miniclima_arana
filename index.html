<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clima en Arana</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background-color: #eef2f3;
      color: #111;
      transition: background 0.3s, color 0.3s;
    }
    .noche {
      background-color: #121212;
      color: #eee;
    }
    header {
      background-color: #2c3e50;
      color: white;
      padding: 1em;
      text-align: center;
    }
    nav {
      display: flex;
      justify-content: center;
      background-color: #34495e;
    }
    nav button {
      flex: 1;
      padding: 1em;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }
    nav button:hover {
      background-color: #2c3e50;
    }
    .seccion {
      display: none;
      padding: 1em;
    }
    .seccion.activa {
      display: block;
    }
    .dato {
      margin: 1em 0;
      font-size: 1.2em;
    }
    .toggle-noche {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 0.5em;
      font-size: 1em;
      cursor: pointer;
      background-color: #ccc;
      border-radius: 0.5em;
    }
    .bot {
      display: inline-block;
      margin-top: 1em;
      padding: 0.5em 1em;
      background-color: #34ace0;
      color: white;
      border-radius: 0.5em;
      text-decoration: none;
      font-size: 1em;
    }
    .bot:hover {
      background-color: #227093;
    }
    @media (max-width: 600px) {
      nav button {
        font-size: 0.9em;
        padding: 0.5em;
      }
      .dato {
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Clima en Arana</h1>
    <div class="toggle-noche">🌙</div>
  </header>

  <nav>
    <button onclick="mostrarSeccion('principal')">Principal</button>
    <button onclick="mostrarSeccion('graficos')">Gráficos</button>
    <button onclick="mostrarSeccion('info')">Información</button>
  </nav>

  <div id="principal" class="seccion activa">
    <div class="dato" id="temp">🌡 Temperatura: ...</div>
    <div class="dato" id="hum">💧 Humedad: ...</div>
    <div class="dato" id="pres">📉 Presión: ...</div>
    <div class="dato" id="roc">🌫 Punto de rocío: ...</div>
    <div class="dato" id="sens">🌬️ Sensación térmica: ...</div>
    <div class="dato" id="estado">Estado: ...</div>
    <div class="dato" id="hora">🕒 Última actualización: ...</div>
    <div class="dato" id="resumen">📊 Resumen diario: ...</div>
    <a href="https://t.me/miniclima_arana_bot" class="bot">🤖 Bot de Telegram</a>
  </div>

  <div id="graficos" class="seccion">
    <iframe width="100%" height="300" style="border: none;" src="https://thingspeak.com/channels/3020883/charts/1?bgcolor=%23ffffff&color=%23d62020&dynamic=true&type=line"></iframe>
    <iframe width="100%" height="300" style="border: none;" src="https://thingspeak.com/channels/3020883/charts/2?bgcolor=%23ffffff&color=%2300aaff&dynamic=true&type=line"></iframe>
  </div>

  <div id="info" class="seccion">
    <p>Estación meteorológica casera en Arana (La Plata).</p>
    <p>Sensores: SHT31 (temp/humedad), BMP180 (presión).</p>
    <p>Datos actualizados cada 10 minutos.</p>
  </div>

  <script>
    const channelID = "3020883";
    const url = `https://api.thingspeak.com/channels/${channelID}/feeds.json?results=48`;

    function mostrarSeccion(id) {
      document.querySelectorAll(".seccion").forEach(sec => sec.classList.remove("activa"));
      document.getElementById(id).classList.add("activa");
    }

    // Modo noche
    if (localStorage.getItem("modoNoche") === "true") {
      document.body.classList.add("noche");
    }
    document.querySelector(".toggle-noche").addEventListener("click", () => {
      document.body.classList.toggle("noche");
      localStorage.setItem("modoNoche", document.body.classList.contains("noche"));
    });

    async function actualizarDatos() {
      try {
        const res = await fetch(url);
        const data = await res.json();
        const ultimo = data.feeds[data.feeds.length - 1];

        const T = parseFloat(ultimo.field1);
        const H = parseFloat(ultimo.field2);
        const P = parseFloat(ultimo.field3);
        const R = parseFloat(ultimo.field4);

        document.getElementById("temp").textContent = `🌡 Temperatura: ${T.toFixed(1)} °C`;
        document.getElementById("hum").textContent  = `💧 Humedad: ${H.toFixed(1)} %`;
        document.getElementById("pres").textContent = `📉 Presión: ${P.toFixed(1)} hPa`;
        document.getElementById("roc").textContent  = `🌫 Punto de rocío: ${R.toFixed(1)} °C`;
        document.getElementById("hora").textContent = `🕒 Última actualización: ${new Date(ultimo.created_at).toLocaleString()}`;

        // Sensación térmica
        const viento_kmh = 12;
        let sensacion;
        if (T < 27) {
          const v = Math.pow(viento_kmh, 0.16);
          sensacion = 13.12 + 0.6215*T - 11.37*v + 0.3965*T*v;
        } else {
          sensacion = T;
        }
        document.getElementById("sens").textContent = `🌬️ Sensación térmica: ${sensacion.toFixed(1)} °C`;

        // Estado simple
        let estado = "🌤 Parcialmente despejado";
        if (H > 90 && T < 20) estado = "🌧 Posible llovizna";
        else if (H < 40 && T > 28) estado = "☀️ Soleado";
        else if (H > 80 && T > 25) estado = "🌦 Calor húmedo";
        document.getElementById("estado").textContent = `Estado: ${estado}`;

        // Resumen diario
        const temps = data.feeds.map(d => parseFloat(d.field1)).filter(v => !isNaN(v));
        const hums = data.feeds.map(d => parseFloat(d.field2)).filter(v => !isNaN(v));
        const promT = temps.reduce((a,b)=>a+b,0) / temps.length;
        const promH = hums.reduce((a,b)=>a+b,0) / hums.length;
        document.getElementById("resumen").textContent = `📊 Promedio Temp: ${promT.toFixed(1)} °C, 💧 Humedad: ${promH.toFixed(1)} %`;
      } catch (e) {
        document.getElementById("temp").textContent = "Error al cargar los datos.";
        console.error("Error:", e);
      }
    }

    actualizarDatos();
    setInterval(actualizarDatos, 60000);
  </script>
</body>
</html>
